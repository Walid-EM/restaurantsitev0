# Syst√®me d'Upload d'Images Dynamique avec Stockage Local

Ce syst√®me permet d'uploader des images dynamiquement et de les stocker dans un dossier local de votre projet Next.js, avec les m√©tadonn√©es stock√©es dans MongoDB.

## üèóÔ∏è Architecture

### Composants cr√©√©s :
- **`Image.ts`** : Mod√®le MongoDB pour stocker les m√©tadonn√©es des images
- **`/api/upload/route.ts`** : API pour l'upload d'images sur le disque
- **`/api/images/[id]/route.ts`** : API pour r√©cup√©rer les images via ID
- **`/api/static/[...path]/route.ts`** : API pour servir les fichiers statiques
- **`ImageUpload.tsx`** : Composant React pour l'upload et l'affichage
- **`MongoImage.tsx`** : Composant utilitaire pour afficher les images

## üöÄ Utilisation

### 1. Page de test
Acc√©dez √† `/test-upload` pour tester le syst√®me d'upload.

### 2. Upload d'images
- Glissez-d√©posez une image ou cliquez pour s√©lectionner
- Formats support√©s : JPG, PNG, GIF, WebP
- Taille maximale : 5MB
- Les images sont automatiquement renomm√©es avec un UUID unique

### 3. Affichage des images
Les images sont accessibles via :
- **Chemin direct** : `/uploads/images/{filename}` (plus rapide)
- **API** : `/api/images/{imageId}` (avec m√©tadonn√©es)

## üíæ Stockage

### **Fichiers images** : Dossier `uploads/images/`
```
uploads/
  ‚îî‚îÄ‚îÄ images/
      ‚îú‚îÄ‚îÄ a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
      ‚îú‚îÄ‚îÄ b2c3d4e5-f6g7-8901-bcde-f23456789012.png
      ‚îî‚îÄ‚îÄ c3d4e5f6-g7h8-9012-cdef-345678901234.gif
```

### **M√©tadonn√©es** : Collection MongoDB `images`
```typescript
{
  _id: ObjectId,
  filename: "a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg",
  originalName: "ma-photo.jpg", 
  contentType: "image/jpeg",
  filePath: "/uploads/images/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg",
  size: 245760,
  uploadedAt: Date,
  createdAt: Date,
  updatedAt: Date
}
```

## üîß Int√©gration dans votre application

### 1. Utiliser le composant MongoImage
```tsx
import MongoImage from '@/components/ui/MongoImage';

// Affichage simple
<MongoImage imageId="64f8a1b2c3d4e5f6a7b8c9d0" alt="Description" />

// Avec chemin direct (plus rapide)
<MongoImage 
  imageId="64f8a1b2c3d4e5f6a7b8c9d0"
  filePath="/uploads/images/filename.jpg"
  alt="Description"
  className="w-32 h-32 object-cover rounded-lg"
  fallback={<div>Image non disponible</div>}
/>
```

### 2. Composants sp√©cialis√©s pour l'administration

#### AdminImageUpload
Composant d'upload avec s√©lecteur d'images existantes :
```tsx
import AdminImageUpload from '@/components/ui/AdminImageUpload';

<AdminImageUpload
  currentImage={product.image}
  currentImageId={product.imageId}
  onImageChange={(imageData) => {
    setProduct({
      ...product,
      image: imageData.filePath,
      imageId: imageData.imageId
    });
  }}
  label="Image du produit"
  required={true}
/>
```

#### AdminImageDisplay
Composant d'affichage avec diff√©rentes tailles :
```tsx
import AdminImageDisplay from '@/components/ui/AdminImageDisplay';

<AdminImageDisplay
  image={product.image}
  imageId={product.imageId}
  alt={product.name}
  size="md" // sm, md, lg, xl
  showPreview={true}
/>
```

### 3. Upload programmatique
```typescript
const uploadImage = async (file: File) => {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch('/api/upload', {
    method: 'POST',
    body: formData,
  });
  
  const result = await response.json();
  if (result.success) {
    console.log('Image upload√©e:', result.image.id);
    console.log('Chemin fichier:', result.image.filePath);
    return result.image;
  }
};
```

## üõ°Ô∏è S√©curit√©

- **Validation des types** : Seules les images sont accept√©es
- **Limite de taille** : Maximum 5MB par fichier
- **Noms uniques** : UUID pour √©viter les conflits
- **Validation MongoDB** : Sch√©ma strict avec champs requis
- **S√©curit√© des chemins** : Validation des extensions de fichiers

## üì± Fonctionnalit√©s

- ‚úÖ Upload par glisser-d√©poser
- ‚úÖ S√©lection de fichier classique
- ‚úÖ Validation en temps r√©el
- ‚úÖ Gestion des erreurs
- ‚úÖ Affichage avec fallback
- ‚úÖ Interface responsive
- ‚úÖ Animations avec Framer Motion
- ‚úÖ Cache des images (1 an)
- ‚úÖ **Stockage local** : Images dans le projet Next.js
- ‚úÖ **M√©tadonn√©es MongoDB** : Gestion des informations

## üîÑ Migration depuis le dossier public/

Pour migrer vos images existantes :

1. **Acc√©der √† la page de migration** : `/migrate-images`
2. **Cliquer sur "D√©marrer la Migration"** pour :
   - Copier toutes les images du dossier `public/` vers `uploads/images/`
   - Cr√©er les documents MongoDB correspondants
   - G√©n√©rer un fichier de mapping pour r√©f√©rence

3. **V√©rifier la migration** :
   - Consulter le r√©sum√© de migration
   - V√©rifier que les images sont dans `uploads/images/`
   - Tester l'affichage via `/test-upload`

4. **Mettre √† jour vos composants** pour utiliser `MongoImage`

5. **Nettoyer le dossier public** (optionnel) :
   - Utiliser le bouton "Nettoyer le dossier public" apr√®s v√©rification
   - ‚ö†Ô∏è **Attention** : Cette action supprime d√©finitivement les images du dossier public

### **Script de migration automatique**

La migration utilise l'API `/api/migrate-images` qui :
- Scanne r√©cursivement le dossier `public/`
- Identifie tous les fichiers images (jpg, png, gif, webp, svg)
- Copie chaque image vers `uploads/images/` avec un nom unique (UUID)
- Cr√©e un document MongoDB avec les m√©tadonn√©es
- G√©n√®re un fichier de mapping `uploads/migration-mapping.json`

### **Fichier de mapping**

Apr√®s migration, un fichier `migration-mapping.json` est cr√©√© avec :
```json
{
  "migrationDate": "2024-08-25T21:15:00.000Z",
  "totalImages": 25,
  "migratedCount": 25,
  "errorCount": 0,
  "images": [
    {
      "originalPath": "Assiette-Plancha.png",
      "newFilename": "a1b2c3d4-e5f6-7890-abcd-ef1234567890.png",
      "mongoId": "64f8a1b2c3d4e5f6a7b8c9d0",
      "filePath": "/uploads/images/a1b2c3d4-e5f6-7890-abcd-ef1234567890.png"
    }
  ]
}
```

## üö® Limitations

- **Taille maximale** : 5MB par image
- **Stockage** : Images stock√©es sur le disque du serveur
- **Performance** : Lecture depuis le disque (plus rapide que MongoDB)
- **Cache** : Cache navigateur + serveur via Next.js

## üîÆ Am√©liorations futures

- [ ] Compression automatique des images
- [ ] G√©n√©ration de thumbnails
- [ ] Support des m√©tadonn√©es EXIF
- [ ] Syst√®me de tags et cat√©gories
- [ ] Gestion des permissions d'acc√®s
- [ ] CDN pour les images
- [ ] Backup automatique du dossier uploads

## üìù Exemple d'utilisation compl√®te

```tsx
import { useState } from 'react';
import MongoImage from '@/components/ui/MongoImage';

export default function ProductCard({ product }) {
  const [imageId, setImageId] = useState(product.imageId);
  const [filePath, setFilePath] = useState(product.filePath);

  const handleImageUpload = async (file) => {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData,
    });
    
    const result = await response.json();
    if (result.success) {
      setImageId(result.image.id);
      setFilePath(result.image.filePath);
      // Mettre √† jour le produit en base
      await updateProductImage(product.id, result.image.id, result.image.filePath);
    }
  };

  return (
    <div className="product-card">
      <MongoImage 
        imageId={imageId}
        filePath={filePath}
        alt={product.name}
        className="w-full h-48 object-cover rounded-lg"
      />
      <h3>{product.name}</h3>
      <input 
        type="file" 
        accept="image/*" 
        onChange={(e) => handleImageUpload(e.target.files[0])}
      />
    </div>
  );
}
```

## üéØ Avantages de cette approche

1. **Performance** : Images servies directement depuis le disque
2. **Flexibilit√©** : Ajout d'images en temps r√©el
3. **Organisation** : M√©tadonn√©es en MongoDB, fichiers sur disque
4. **S√©curit√©** : Validation et contr√¥le d'acc√®s
5. **Maintenance** : Gestion centralis√©e des images
6. **Backup** : Fichiers et m√©tadonn√©es s√©par√©s
7. **Scalabilit√©** : Possibilit√© de migrer vers un CDN plus tard

## üéõÔ∏è Interface d'Administration

### Int√©gration compl√®te dans l'admin
L'interface d'administration a √©t√© mise √† jour pour utiliser le nouveau syst√®me d'images :

- **Formulaires de produits** : Upload et s√©lection d'images avec `AdminImageUpload`
- **Formulaires de cat√©gories** : Gestion des images obligatoires
- **Formulaires de suppl√©ments** : Support des images optionnelles
- **Affichage des listes** : Utilisation de `AdminImageDisplay` pour toutes les images

### Page de test
Acc√©dez √† `/admin/test-images` pour tester :
- Upload de nouvelles images
- S√©lection d'images existantes
- Affichage en diff√©rentes tailles
- Gestion des fallbacks

### Fonctionnalit√©s de l'admin
1. **Upload direct** : Glisser-d√©poser ou s√©lection de fichier
2. **S√©lecteur d'images** : Modal pour choisir parmi les images existantes
3. **Pr√©visualisation** : Affichage imm√©diat des images s√©lectionn√©es
4. **Gestion des erreurs** : Validation et messages d'erreur
5. **Interface responsive** : Adaptation mobile et desktop

### Gestionnaire d'images complet
L'onglet "Images" de l'admin offre :
- **Vue d'ensemble** : Toutes les images upload√©es avec m√©tadonn√©es
- **Recherche et filtres** : Par nom, type de fichier
- **Actions en lot** : S√©lection multiple et suppression group√©e
- **Pr√©visualisation** : Affichage des images avec informations d√©taill√©es
- **T√©l√©chargement** : Acc√®s direct aux fichiers
- **Suppression s√©curis√©e** : Suppression des fichiers et m√©tadonn√©es

## üöÄ D√©marrage Rapide

### 1. Migration des images existantes
```bash
# Acc√©der √† la page de migration
http://localhost:3000/migrate-images

# Cliquer sur "D√©marrer la Migration"
# V√©rifier les r√©sultats
# Optionnel : Nettoyer le dossier public
```

### 2. Test du syst√®me
```bash
# Page de test g√©n√©rale
http://localhost:3000/test-upload

# Page de test admin
http://localhost:3000/admin/test-images

# Gestionnaire d'images
http://localhost:3000/admin ‚Üí Onglet "Images"
```

### 3. Utilisation dans vos composants
```tsx
// Remplacer les anciennes images
<img src={product.image} alt={product.name} />

// Par le nouveau composant
<MongoImage 
  imageId={product.imageId}
  filePath={product.image}
  alt={product.name}
  className="w-full h-48 object-cover rounded-lg"
/>
```

## üéØ R√©sum√© des Avantages

‚úÖ **Performance** : Images servies directement depuis le disque  
‚úÖ **Flexibilit√©** : Upload dynamique et s√©lection d'images existantes  
‚úÖ **Organisation** : M√©tadonn√©es MongoDB + fichiers organis√©s  
‚úÖ **S√©curit√©** : Validation, types de fichiers, tailles limit√©es  
‚úÖ **Maintenance** : Interface admin compl√®te pour la gestion  
‚úÖ **Migration** : Outil automatique pour les images existantes  
‚úÖ **Scalabilit√©** : Architecture pr√™te pour CDN et stockage cloud  
‚úÖ **UX** : Interface moderne avec glisser-d√©poser et pr√©visualisation  

**Votre syst√®me d'images est maintenant pr√™t pour la production ! üöÄ**
